{% extends 'doctor-base.html' %}

{% block customLinks %}
<script type="text/javascript">
    $(document).ready(function(){

        $(".accept-btn").on("click",function(e) {
            e.preventDefault();
            var btn=$(this);
            btn.prop("disabled",true);
            btn.html("<i class='fa fa-spinner fa-pulse fa-fw' aria-hidden='true'></i>");
            $.post(btn.data("href"),{csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()},function(data){
                if(data=='true'){
                    btn.html("Accepted sucessfully");
                }
                else{
                    alert( "Something went wrong. Try again." );
                    btn.html("Accept");
                    btn.prop("disabled",false);
                }
            }).fail(function(){
                    alert( "Something went wrong. Try again." );
                    btn.html("Accept");
                    btn.prop("disabled",false);
                });
        });

        $(".delete-btn").on("click",function(e) {
            e.preventDefault();
            var btn=$(this);
            btn.prop("disabled",true);
            btn.html("<i class='fa fa-spinner fa-pulse fa-fw' aria-hidden='true'></i>");
            $.post(btn.data("href"),{csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()},function(data){
                if(data=='true'){
                    $('#'+btn.data("pid")+'-proposal').remove();
                    alert("Proposal deleted sucessfully.");
                }
                else{
                    alert( "Something went wrong. Try again." );
                    btn.html("Delete");
                    btn.prop("disabled",false);
                }
            }).fail(function(){
                    alert( "Something went wrong. Try again." );
                    btn.html("Delete");
                    btn.prop("disabled",false);
                });
        });

        $(".report-btn").on("click",function(e) {
            e.preventDefault();
            var btn=$(this);
            btn.prop("disabled",true);
            btn.html("<i class='fa fa-spinner fa-pulse fa-fw' aria-hidden='true'></i>");
            $.post(btn.data("href"),{csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()},function(data){
                if(data=='true'){
                    $('#'+btn.data("pid")+'-proposal').remove();
                    alert( "We have receive you report. We will look this proposal and in case of any ethical problem, we will delete it and and take action against the proposal sender according to our terms." );
                }
                else{
                    alert( "Something went wrong. Try again." );
                    btn.html("Report");
                    btn.prop("disabled",false);
                }
            }).fail(function(){
                    alert( "Something went wrong. Try again." );
                    btn.html("Report");
                    btn.prop("disabled",false);
                });
        });

    });
</script>
{% endblock %}

{% block content %}
    <div class="container-fluid pr-content-wrapper my-5">
            <div class="row justify-content-center">
                <div class="proposal col-md-8">
                    {% if proposals_data.length != 0 %}
                        {% load static %}
                        {% csrf_token %}

                        {% for proposal in proposals_data %}
                                
                            {% if not proposal.reported %}                    
                                <div class="card mt-3" id="{{ proposal.key }}-proposal">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="mr-2">
                                                    <a href="/patient/{{ proposal.patient_id }}/view_profile">
                                                    {% if proposal.patient_pic != "" %}
                                                        <img class="rounded-circle" width="45" height="45" src="{{ proposal.patient_pic.url }}" alt="Avatar">
                                                    {% else %}
                                                        <img class="rounded-circle" width="45" height="45" src="{% static 'images/no-profile-pic.png' %}" alt="Avatar">
                                                    {% endif %}
                                                    </a>
                                                </div>
                                                <div class="ml-2">
                                                    <div class="h7 text-muted">{{ proposal.patient_name }}</div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="dropdown">
                                                    <button class="btn btn-link dropdown-toggle" type="button" id="gedf-drop1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        <i class="fa fa-ellipsis-h"></i>
                                                    </button>
                                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="gedf-drop1">
                                                        <button type="button" class="btn btn-link dropdown-item delete-btn" data-pid="{{ proposal.key }}" data-href="/doctor/{{ request.session.user_id }}/proposal/{{ proposal.key }}/delete">Delete</button>
                                                        <button type="button" class="btn btn-link dropdown-item report-btn" data-pid='{{ proposal.key }}' data-href="/doctor/{{ request.session.user_id }}/proposal/{{ proposal.key }}/report">Report</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-muted h7 mb-2"> <i class="fa fa-clock-o"></i> {{ proposal.created_at }}</div>
                                        <p class="paraCollapse collapse card-text" id="{{ proposal.key }}">
                                            {{ proposal.proposal_data }}
                                        </p>
                                        <a role="button" class="collapsed" data-toggle="collapse" href="#{{ proposal.key }}" aria-expanded="false" aria-controls="{{ proposal.key }}"></a>
                                        
                                        <script type="text/javascript">
                                            if( $('#{{ proposal.key }}').height() < 71 ){
                                                $('#{{ proposal.key }}').next('a').remove();
                                                $('#{{ proposal.key }}').removeClass("collapse");
                                            }
                                        </script>

                                    </div>
                                    <div class="card-footer">
                                        {% if proposal.accepted %}                                             
                                            <button type="button" class="card-link btn btn-sm btn-outline-primary float-right" disabled>Already Accepted</button>
                                        {% else %}
                                            <button type="button" class="btn btn-success float-right accept-btn" id="{{ proposal.key }}-accept-button" data-href="/doctor/{{ request.session.user_id }}/proposal/{{ proposal.key }}/accept">Accept</button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
            
                    {% else %}
                        <div class="alert alert-success my-auto" role="alert" id="post-sub-message" style="text-align:center;">
                            <h4>No proposal is submitted yet on this post.</h4>
                        </div> 
                    {% endif %}

                </div>        
            </div>
    </div>

    {% endblock %}


